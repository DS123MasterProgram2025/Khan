---
title: "Лабораторна робота № 4. Частина II: Tidymodels"
author: "Хань Євгеній"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

**Мета:** Опанувати процес побудови моделей класифікації з використанням екосистеми пакетів `tidymodels`. Побудувати модель LDA для датасета `palmerpenguins`.

## Виконання роботи

```{r lab4_part2_tidymodels, echo=TRUE, message=FALSE, warning=FALSE}
ensure_package <- function(pkg) {
  if (!requireNamespace(pkg, quietly = TRUE)) {
    install.packages(pkg, repos = "[http://cran.us.r-project.org](http://cran.us.r-project.org)", dependencies = TRUE)
  }
}
pkgs <- c("tidymodels", "palmerpenguins", "discrim", "MASS", "tidyverse", "yardstick")
invisible(lapply(pkgs, ensure_package))

library(tidymodels)   
library(palmerpenguins) 
library(discrim)      
library(tidyverse)    
library(MASS)        

data("penguins")

df_penguins <- penguins %>%
  drop_na() %>%
  dplyr::select(-year) 

set.seed(123)
data_split <- initial_split(df_penguins, prop = 0.75, strata = sex)

train_data <- training(data_split)
test_data  <- testing(data_split)

print(paste("Навчальна вибірка:", nrow(train_data), "рядків"))
print(paste("Тестова вибірка:", nrow(test_data), "рядків"))


penguin_recipe <- recipe(sex ~ ., data = train_data) %>%
  step_zv(all_predictors()) %>%
  step_normalize(all_numeric_predictors()) %>%
  step_dummy(all_nominal_predictors())


lda_spec <- discrim_linear() %>%
  set_engine("MASS") %>%
  set_mode("classification")

penguin_wf <- workflow() %>%
  add_recipe(penguin_recipe) %>%
  add_model(lda_spec)


penguin_fit <- fit(penguin_wf, data = train_data)

print("Результат навчання (коефіцієнти LDA):")
print(penguin_fit)


penguin_preds <- predict(penguin_fit, test_data) %>%
  bind_cols(predict(penguin_fit, test_data, type = "prob")) %>%
  bind_cols(test_data %>% dplyr::select(sex))


head(penguin_preds)


cm <- conf_mat(penguin_preds, truth = sex, estimate = .pred_class)
print(cm)


multi_metric <- metric_set(accuracy, sensitivity, specificity, kap)
metrics_res <- multi_metric(penguin_preds, truth = sex, estimate = .pred_class)

print("Метрики якості моделі:")
print(metrics_res)


penguin_preds %>%
  roc_curve(truth = sex, .pred_female) %>%
  autoplot() +
  ggtitle("ROC-крива для моделі LDA (Tidymodels)")